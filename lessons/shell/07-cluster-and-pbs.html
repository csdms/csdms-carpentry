<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <title>Software Carpentry: The Unix Shell</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="alternate" type="application/rss+xml" title="Software Carpentry Blog" href="http://software-carpentry.org/feed.xml"/>
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="http://software-carpentry.org" title="Software Carpentry">
          <img alt="Software Carpentry banner" src="img/software-carpentry-banner.png" />
        </a>
      </div>
      <article>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
                    <a href="index.html"><h1 class="title">The Unix Shell</h1></a>
          <h2 class="subtitle">Cluster Computing and PBS Commands</h2>
          <section class="objectives panel panel-warning">
<div class="panel-heading">
<h2 id="learning-objectives"><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Understand how a cluster differs from a desktop computer</li>
<li>Be able to submit a job to a queue and check its status</li>
</ul>
</div>
</section>
<p>A cluster computer is a supercomputer constructed from individual cheap, replaceable computers, called <a href="reference.html#node">nodes</a>, that are linked by a fast network. Each node has its own operating system, usually a Linux variant. In a typical setup, one of the nodes in the cluster is configured as the <a href="reference.html#head-node">head node</a>, which acts as the controller for the cluster. The remainder of the nodes are configured as <a href="reference.html#compute-node">compute nodes</a>. They perform work in the cluster. Through the use of specially designed software, the nodes of a cluster act as a single computer.</p>
<p>A typical cluster is diagrammed here:</p>
<div class="figure">
<img src="fig/Beowulf.png" alt="A typical cluster computer configuration. (Public domain image from https://en.wikipedia.org/wiki/File:Beowulf.png)" />
<p class="caption">A typical cluster computer configuration. (Public domain image from https://en.wikipedia.org/wiki/File:Beowulf.png)</p>
</div>
<p>Note how the outside world can only communicate with the cluster through the server (i.e., the head node, in the terminology we’re using); the compute nodes are hidden. The head node is linked to the compute nodes through a local network. The head node and the compute nodes may also share a locally networked storage device.</p>
<aside class="callout panel panel-info">
<div class="panel-heading">
<h2 id="head-node-use"><span class="glyphicon glyphicon-pushpin"></span>Head node use</h2>
</div>
<div class="panel-body">
<p>The head node is only to be used for</p>
<ul>
<li>cluster access</li>
<li>job scheduling</li>
<li>communication with the compute nodes</li>
</ul>
<p>Heavy computational use may cause the head node to become unresponsive, limiting its availability to outside users and impeding job monitoring. Always use <a href="reference.html#portable-batch-system">PBS</a> commands (below) to perform computational work on a cluster.</p>
</div>
</aside>
<h3 id="working-on-a-cluster">Working on a cluster</h3>
<p>The typical way of working on a cluster is to submit a <a href="reference.html#job">job</a> to the <a href="reference.html#scheduler">scheduler</a> that resides on the head node. A job is organized as a script, typically written in bash or in Python, that contains commands to perform tasks. If more than one job is scheduled, they’re assigned to a <a href="reference.html#job-queue">queue</a> by the scheduler. When adequate computing resources become available, a job is popped off of the queue and run. After the run completes, any output can be collected and transferred from the cluster to a user’s local computer.</p>
<p>The CSDMS cluster uses the <a href="http://www.adaptivecomputing.com/products/open-source/torque/">TORQUE</a> job scheduler, which employs <a href="reference.html#Portable-Batch-System">PBS</a> commands to submit and monitor jobs on the cluster. Key PBS commands are:</p>
<ul>
<li><code>qsub</code> to submit a job to the queue</li>
<li><code>qstat</code> to show the status of a job</li>
<li><code>qdel</code> to remove a job from the queue</li>
</ul>
<p>Detailed information on these commands can be found on their respective <code>man</code> pages; e.g.,</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">man</span> qsub</code></pre></div>
<h3 id="accessing-the-csdms-cluster">Accessing the CSDMS cluster</h3>
<p>CSDMS maintains a cluster computer, <strong><em>beach</em></strong>, an SGI Altix XE1300 with 88 Altix XE320 compute nodes. Each compute node is configured with two quad-core 3.0 GHz E5472 (Harpertown) processors, for a total of 704 cores. Twenty-six of the 88 nodes have 4 GB of memory per core, while the remainder have 2 GB of memory per core. The cluster is controlled through an Altix XE250 head node. Internode communication is accomplished through either gigabit ethernet or over a non-blocking InfiniBand fabric. Each compute node has 250 GB of local temporary storage. All nodes are able to access 36 TB of RAID storage through NFS.</p>
<p>To access the CSDMS cluster, log into the head node of <strong><em>beach</em></strong> from your computer, using the <code>ssh</code> (“secure shell”) command:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ssh</span> [username@]beach.colorado.edu</code></pre></div>
<p>Be sure to replace <code>[username]</code> with the user name assigned to you on <strong><em>beach</em></strong>. You’ll be prompted for your password on <strong><em>beach</em></strong>, which is your CU IdentiKey. A successful login will look something like this:</p>
<pre class="output"><code>Last login: Mon May  9 13:17:19 2016 from solaria.colorado.edu
]
] For assistance please mail trouble@colorado.edu
]

$</code></pre>
<p>where the command prompt is now on <strong><em>beach</em></strong>. Check that you’re in your home directory:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">pwd</span></code></pre></div>
<aside class="callout panel panel-info">
<div class="panel-heading">
<h2 id="off-campus-access-to-the-csdms-cluster"><span class="glyphicon glyphicon-pushpin"></span>Off-campus access to the CSDMS cluster</h2>
</div>
<div class="panel-body">
<p>To access <strong><em>beach</em></strong> from outside of the CU-Boulder campus, you’ll need to establish a Virtual Private Network (VPN) connection to the campus. The campus Office of Information Technology provides <a href="http://www.colorado.edu/oit/services/network-internet-services/vpn">instructions</a> for downloading and installing VPN software. Once a VPN connection is established, you can connect to <strong><em>beach</em></strong> as above.</p>
</div>
</aside>
<h3 id="tranferring-files">Tranferring files</h3>
<p>We need to transfer the files in the <strong>code-shell</strong> directory from your local computer to <strong><em>beach</em></strong>. Open a new terminal window on your local computer, change to your <strong>Desktop</strong> directory, and get a directory listing:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">cd</span> ~/Desktop
$ <span class="kw">ls</span></code></pre></div>
<pre class="output"><code>code-shell  data-shell</code></pre>
<p>To transfer the files, the command we use is <code>scp</code> (“secure copy”). In the terminal on your local computer, type:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">scp</span> -r code-shell [username@]beach.colorado.edu:~</code></pre></div>
<p>where the <code>-r</code> flag tells <code>scp</code> to recursively copy the contents of the <strong>code-shell</strong> directory and the <code>~</code> at the end of the command is the location to copy to on <strong><em>beach</em></strong>, your home directory. Be sure to replace <code>[username]</code> with your <strong><em>beach</em></strong> user name. You’ll be prompted for your <strong><em>beach</em></strong> password.</p>
<p>In a terminal you’ve connected to <strong><em>beach</em></strong>, change to your home directory and check that the files are present.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">cd</span>
$ <span class="kw">ls</span></code></pre></div>
<h3 id="submitting-a-batch-job">Submitting a batch job</h3>
<p>On <strong><em>beach</em></strong>, change to the <strong>code-shell</strong> directory and list its contents:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">cd</span> ~/code-shell
$ <span class="kw">ls</span></code></pre></div>
<pre class="output"><code>calculate_pi.pbs.sh  calculate_pi.py  simple.pbs.sh</code></pre>
<p>The file <code>simple.pbs.sh</code> is an example of a PBS script. Dump the contents of this script to the terminal with <code>cat</code>:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">cat</span> simple.pbs.sh</code></pre></div>
<pre class="output"><code>#!/usr/bin/env bash
# A simple PBS script. Submit this script to the queue manager with:
#
#  $ qsub simple.pbs.sh

echo &quot;Hello world!&quot;</code></pre>
<p>This script, when run, will print “Hello world!” to standard output.</p>
<p><em>TODO: discuss queues.</em></p>
<p>Cluster computers often have several queues with different properties, for example, a high-memory queue, a long run queue, a debugging queue, and a default queue. View the queues available on the CSDMS cluster with <code>qstat</code>:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">qstat</span> -q</code></pre></div>
<p>The <code>-q</code> flag prompts <code>qstat</code> to output only queue information.</p>
<pre class="output"><code>server: beach.colorado.edu

Queue            Memory CPU Time Walltime Node  Run Que Lm  State
---------------- ------ -------- -------- ----  --- --- --  -----
ocean-owner        --      --       --      --    0   0 --   E R
wrf-owner          --      --       --      --    0   0 --   E R
ocean-special      --      --       --      --    0   0 --   E R
route              --      --       --      --    0   0 --   E R
total              --      --       --      --    0   0 --   E R
wrf                --      --    12:00:00   --    0   0 --   E R
default            --      --    96:00:00   --  105  77 --   E R
himem              --      --       --      --    2  10 --   E R
debug              --      --    02:00:00   --    0   0 --   E R
long               --      --       --      --    0   0 12   E R
wrf-special        --      --       --      --    0   0 --   E R
vip                --      --    24:00:00   --    0   0 --   E R
ocean              --      --    12:00:00   --    0   0 --   E R
                                               ----- -----
                                                107  87</code></pre>
<p>Submit this script to the scheduler with <code>qsub</code>:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">qsub</span> -q debug simple.pbs.sh</code></pre></div>
<p>The scheduler returns a job id:</p>
<pre class="output"><code>197180.beach.colorado.edu</code></pre>
<p>Ordinarily, this job could be queried with <code>qstat</code>, but this job runs really quickly. In fact, by the time you’ve read this, it will have completed.</p>
<p>Interactive batch job.</p>
<p>Choosing a queue.</p>
<p>Email notification.</p>
<p>More information on submitting PBS jobs, including examples, can be <a href="http://csdms.colorado.edu/wiki/HPCC_usage_rules">found</a> on the CSDMS web site.</p>
<h3 id="checking-the-status-of-batch-jobs">Checking the status of batch jobs</h3>
<p>Check the all of the current jobs in all the queues on <strong><em>beach</em></strong> with the <code>qstat</code> command:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">qstat</span></code></pre></div>
<pre class="output"><code>Job ID                    Name             User            Time Use S Queue
------------------------- ---------------- --------------- -------- - -----
195567.beach               WBMsed3.11       frdu8933        295:39:1 R himem
195568.beach               WBMsed3.8        frdu8933        295:34:1 R himem
195569.beach               WBMsed3.5        frdu8933               0 Q himem
195570.beach               WBMsed3.2        frdu8933               0 Q himem
195571.beach               WBMsed3.10       frdu8933               0 Q himem
195578.beach               WBMsed3.3        frdu8933               0 Q himem
195972.beach               dem              jimc5170        24:54:08 R default
196667.beach               dem              jimc5170        45:57:19 R default
196670.beach               dem              jimc5170        44:18:05 R default
196673.beach               dem              jimc5170        44:31:45 R default
...</code></pre>
<section class="challenge panel panel-success">
<div class="panel-heading">
<h2 id="which-compute-nodes-are-being-used"><span class="glyphicon glyphicon-pencil"></span>Which compute nodes are being used?</h2>
</div>
<div class="panel-body">
<p>After you submit a PBS script to the scheduler, can you use <code>qstat</code> to find what compute node(s) your job is running on?</p>
</div>
</section>
        </div>
      </div>
      </article>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/swcarpentry/shell-novice">Source</a>
        <a class="label swc-blue-bg" href="mailto:admin@software-carpentry.org">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="http://software-carpentry.org/v5/js/jquery-1.9.1.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
  </body>
</html>
